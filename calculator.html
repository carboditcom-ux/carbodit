<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>কার্বন ক্যালকুলেটর - Carbodit</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-green: #1b4332;
            --accent-gold: #f39c12;
            --light-bg: #f8fdf9;
            --white: #ffffff;
        }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--light-bg); display: flex; justify-content: center; padding: 20px; }
        .container { background: var(--white); width: 100%; max-width: 500px; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        h2, h3 { color: var(--primary-green); text-align: center; }
        
        .input-group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 16px; color: #444; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 12px; box-sizing: border-box; font-size: 16px; outline: none; }
        input:focus { border-color: var(--primary-green); }
        
        button { width: 100%; padding: 14px; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; margin-top: 10px; font-size: 16px; transition: 0.3s; }
        .btn-add { background: var(--primary-green); color: white; }
        .btn-finish { background: var(--accent-gold); color: white; margin-top: 20px; font-size: 1.1em; }
        
        .tree-list-box { margin-top: 20px; display: none; text-align: left; }
        .tree-card { 
            background: #fdfdfd; border: 1px solid #eee; padding: 10px 15px; 
            border-radius: 12px; margin-bottom: 8px; display: flex; 
            justify-content: space-between; align-items: center; 
        }
        .tree-card span { font-size: 14px; color: #333; }
        .tree-card i { color: #e74c3c; cursor: pointer; padding: 5px; }

        #result-page { display: none; text-align: center; }
        .credit-badge { 
            background: #eafaf1; 
            padding: 20px; 
            border-radius: 50%; 
            width: 140px; 
            height: 140px; 
            margin: 20px auto; 
            font-size: 2em; 
            font-weight: bold; 
            color: var(--primary-green); 
            border: 5px solid var(--primary-green);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 15px rgba(27,67,50,0.2);
        }
        .money-box { background: #fff8e1; padding: 15px; border-radius: 15px; border: 1px dashed #f39c12; margin: 20px 0; }
        .bdt-amount { font-size: 1.8em; color: #e67e22; font-weight: bold; }
        .info-msg { background: #e8f4fd; padding: 15px; border-radius: 12px; color: #2980b9; font-size: 14px; line-height: 1.6; margin-top: 15px; border-left: 5px solid #3498db; }
        .warning-msg { background: #fff5f5; color: #c0392b; border-left: 5px solid #e74c3c; }
        .payment-msg { color: #d35400; font-weight: bold; margin-top: 10px; font-size: 13px; display: block; }
        
        .nav-btns { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .row-btns { display: flex; gap: 10px; }
        .profile-btn { background: var(--primary-green); color: white; flex: 1; text-decoration: none; display: flex; align-items: center; justify-content: center; border-radius: 50px; height: 50px; font-weight: bold; }
        .re-entry-btn { background: #555; color: white; flex: 1; border-radius: 50px; height: 50px; font-weight: bold; border: none; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div id="main-app">
        <h2><i class="fas fa-tree"></i> গাছের তথ্য প্রদান</h2>
        <div class="input-group">
            <label>জমির আয়তন (শতাংশ)</label>
            <input type="number" id="plotArea" value="100">
        </div>
        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
        <div class="input-group">
            <label>গাছের প্রজাতি নির্বাচন করুন</label>
            <select id="species">
                <option value="Swietenia mahagoni">মেহগনি (Mahagoni)</option>
                <option value="Mangifera indica">আম (Mango)</option>
                <option value="Jackfruit">কাঁঠাল (Jackfruit)</option>
                <option value="Eucalyptus">ইউক্যালিপটাস (Eucalyptus)</option>
                <option value="Acacia">আকাশমণি (Acacia)</option>
            </select>
        </div>
        <div class="input-group">
            <label>গাছের পরিধি (CBH) সেমি-তে</label>
            <input type="number" id="cbh" placeholder="বুকের উচ্চতায় মাপুন">
        </div>
        <button class="btn-add" onclick="addTree()"><i class="fas fa-plus"></i> তালিকায় গাছ যুক্ত করুন</button>
        
        <div id="treeCountDisplay" style="margin-top:15px; text-align: center; font-weight: bold; color: #666;">
            যুক্ত করা মোট গাছ: ০ টি
        </div>

        <div id="treeListBox" class="tree-list-box">
            <p style="font-size: 13px; color: #888; margin-bottom: 10px;">সংগৃহীত তালিকা:</p>
            <div id="treeListItems"></div>
        </div>

        <button class="btn-finish" onclick="processCarbonData()">ফলাফল দেখুন</button>
        <a href="home.html" style="display:block; text-align:center; margin-top:15px; color:#666; text-decoration:none;">← ফিরে যান</a>
    </div>

    <div id="result-page">
        <h3 id="res-title">কার্বন রিপোর্ট</h3>
        <p id="res-desc">আপনার অর্জিত ফলাফল:</p>
        
        <div class="credit-badge" id="display-value">০.০০</div>
        
        <div class="money-box" id="money-section">
            <p>অর্জিত আয় ($১০/ক্রেডিট):</p>
            <div class="bdt-amount" id="money-bdt">৳ ০.০০</div>
            <span class="payment-msg"><i class="fas fa-mobile-alt"></i> আপনাকে আপনার মোট টাকা পরবর্তীতে মোবাইল ব্যাংকিং এর মাধ্যমে প্রদান করা হবে।</span>
        </div>

        <div id="status-message" class="info-msg"></div>

        <div class="nav-btns">
            <div class="row-btns">
                <button class="re-entry-btn" onclick="resetCalculator()">পুনরায় ডাটা এন্ট্রি করুন</button>
                <a href="farmer_profile.html" class="profile-btn">প্রোফাইলে জমা দেখুন</a>
            </div>
            <a href="home.html" style="display:block; text-align:center; margin-top:10px; color:#1b4332; font-weight:bold; text-decoration:none;">হোম পেজে ফিরে যান</a>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDkaLVe0rDY7ZrKg1NFjCVmmcQ9YoDDio",
        authDomain: "carbodit-1986a.firebaseapp.com",
        projectId: "carbodit-1986a",
        storageBucket: "carbodit-1986a.firebasestorage.app",
        messagingSenderId: "288440338617",
        appId: "1:288440338617:web:97794207671d0d2aedb368"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let farmerTrees = [];
    const USD_TO_BDT = 120;
    const PRICE_PER_CREDIT = 10;

    function toBengali(num) {
        if (num === null || num === undefined) return '০';
        const bng = ['০', '১', '২', '৩', '৪', '৫', '৬', '৭', '৮', '৯'];
        return num.toString().replace(/\d/g, d => bng[d]);
    }

    function renderTreeList() {
        const listBox = document.getElementById('treeListBox');
        const listItems = document.getElementById('treeListItems');
        listItems.innerHTML = '';
        if (farmerTrees.length > 0) {
            listBox.style.display = 'block';
            farmerTrees.forEach((tree, index) => {
                const speciesName = document.querySelector(`#species option[value="${tree.species}"]`).text;
                listItems.innerHTML += `
                    <div class="tree-card">
                        <span>${toBengali(index + 1)}. <b>${speciesName}</b> (${toBengali(tree.cbh)} সেমি)</span>
                        <i class="fas fa-trash-alt" onclick="removeTree(${index})"></i>
                    </div>
                `;
            });
        } else {
            listBox.style.display = 'none';
        }
    }

    function addTree() {
        const species = document.getElementById('species').value;
        const cbh = document.getElementById('cbh').value;
        if (!cbh || cbh <= 0) return alert("দয়া করে পরিধি লিখুন");
        farmerTrees.push({ species, cbh: parseFloat(cbh) });
        document.getElementById('cbh').value = '';
        document.getElementById('treeCountDisplay').innerText = `যুক্ত করা মোট গাছ: ${toBengali(farmerTrees.length)} টি`;
        renderTreeList();
    }

    function removeTree(index) {
        farmerTrees.splice(index, 1);
        document.getElementById('treeCountDisplay').innerText = `যুক্ত করা মোট গাছ: ${toBengali(farmerTrees.length)} টি`;
        renderTreeList();
    }

    function calculateStock() {
        const areaDec = parseFloat(document.getElementById('plotArea').value) || 0;
        const areaHa = areaDec * (1 / 247.1);
        let totalBiomassKg = 0;
        farmerTrees.forEach(t => {
            const dbh = t.cbh / 3.1416;
            const th = 1.3 * Math.pow(dbh, 0.6);
            let ln_tagdb = 0;
            if (t.species === "Swietenia mahagoni") ln_tagdb = -3.8398 + (2.8593 * Math.log(dbh)) - (0.1114 * Math.log(th));
            else if (t.species === "Mangifera indica") ln_tagdb = -3.5905 + (0.9551 * Math.log(Math.pow(dbh, 2) * th));
            else if (t.species === "Jackfruit") ln_tagdb = -0.8971 + (1.9908 * Math.log(dbh));
            else if (t.species === "Eucalyptus") ln_tagdb = -2.663 + (1.915 * Math.log(dbh)) + (0.832 * Math.log(th));
            else if (t.species === "Acacia") ln_tagdb = -2.3807 + (1.4765 * Math.log(dbh));
            totalBiomassKg += Math.exp(ln_tagdb);
        });
        const totalCAB = (totalBiomassKg / 1000) * 0.47;
        const biomassDensity = (totalBiomassKg / 1000) / areaHa;
        const rRatio = (biomassDensity < 20) ? 0.56 : 0.28;
        const totalCarbon = totalCAB * (1 + rRatio);
        return parseFloat((totalCarbon * (44 / 12)).toFixed(2)); 
    }

    function processCarbonData() {
        if (farmerTrees.length === 0) return alert("আগে গাছ যুক্ত করুন!");
        const currentStock = calculateStock();
        const previousStock = parseFloat(localStorage.getItem('totalCarbonStock')) || 0;
        const farmerPhone = localStorage.getItem('farmerPhone') || "Unknown";
        
        const statusMsg = document.getElementById('status-message');
        const moneySection = document.getElementById('money-section');
        const displayVal = document.getElementById('display-value');
        
        document.getElementById('main-app').style.display = 'none';
        document.getElementById('result-page').style.display = 'block';

        // ডাটাবেজে সাবমিশন রেকর্ড করা (হিস্ট্রির জন্য)
        db.collection("farmer_submissions").add({
            phone: farmerPhone,
            total_carbon_stock: currentStock,
            tree_count: farmerTrees.length,
            submittedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        if (previousStock === 0) {
            document.getElementById('res-title').innerText = "কার্বন স্টক রিপোর্ট";
            document.getElementById('res-desc').innerText = "আপনার জমির প্রাথমিক কার্বন স্টক:";
            displayVal.innerText = toBengali(currentStock);
            moneySection.style.display = 'none';
            statusMsg.className = "info-msg";
            statusMsg.innerText = "আপনি যদি সরাসরি কার্বন ক্রেডিট দেখতে চান, তবে ভবিষ্যতে আপনাকে পুনরায় ডাটা এন্ট্রি করতে হবে।";
            localStorage.setItem('totalCarbonStock', currentStock);
        } else {
            const netCredit = currentStock - previousStock;
            if (netCredit <= 0) {
                document.getElementById('res-title').innerText = "কার্বন স্টক রিপোর্ট";
                document.getElementById('res-desc').innerText = "আপনার জমির সর্বশেষ কার্বন স্টক:";
                displayVal.innerText = toBengali(currentStock); 
                moneySection.style.display = 'none';
                statusMsg.className = "info-msg warning-msg";
                statusMsg.innerText = "আপনার কার্বন স্টক এর কোনো পরিবর্তন হয় নাই।";
            } else {
                document.getElementById('res-title').innerText = "কার্বন ক্রেডিট সার্টিফিকেট";
                document.getElementById('res-desc').innerText = "বর্তমান সেশনে অর্জিত ক্রেডিট:";
                displayVal.innerText = toBengali(netCredit.toFixed(2));
                moneySection.style.display = 'block';
                const earningsBDT = netCredit * PRICE_PER_CREDIT * USD_TO_BDT;
                document.getElementById('money-bdt').innerText = `৳ ${toBengali(Math.round(earningsBDT).toLocaleString())}`;
                statusMsg.className = "info-msg";
                statusMsg.innerText = "অভিনন্দন! আপনার নতুন কার্বন ক্রেডিট প্রোফাইলে জমা করা হয়েছে।";
                
                // প্রোফাইল পেজের জন্য ডাটা সেভ করা
                localStorage.setItem('lastCalculatedCredit', netCredit.toFixed(2));
                localStorage.setItem('totalCarbonStock', currentStock);
            }
        }
    }

    function resetCalculator() {
        farmerTrees = [];
        document.getElementById('treeCountDisplay').innerText = `যুক্ত করা মোট গাছ: ০ টি`;
        document.getElementById('cbh').value = '';
        renderTreeList();
        document.getElementById('main-app').style.display = 'block';
        document.getElementById('result-page').style.display = 'none';
    }
</script>
</body>
</html>